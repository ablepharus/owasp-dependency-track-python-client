#!/usr/bin/env python3
"""Enable vulnerability sources in Dependency-Track via API."""

from __future__ import annotations

import os
import sys
from pathlib import Path

REPO_ROOT = Path(__file__).resolve().parents[1]
sys.path.insert(0, str(REPO_ROOT))

try:
    from dotenv import load_dotenv
except ImportError:
    def load_dotenv(path):
        """Minimal dotenv implementation."""
        if not path.exists():
            return
        for line in path.read_text().splitlines():
            line = line.strip()
            if not line or line.startswith('#'):
                continue
            if '=' in line:
                key, value = line.split('=', 1)
                os.environ[key.strip()] = value.strip().strip('"\'')

from owasp_dt.api.config_property import update_config_property
from owasp_dt.models import ConfigProperty, ConfigPropertyPropertyType
from test import api, base_dir


def load_env() -> None:
    """Load environment variables from test.env."""
    env_path = base_dir / "test.env"
    if env_path.exists():
        load_dotenv(env_path)


def enable_source(client, source_name: str) -> bool:
    """Enable a vulnerability source (nvd, osv, github.advisories, etc.)."""
    prop = ConfigProperty(
        group_name="vuln-source",
        property_name=f"{source_name}.enabled",
        property_value="true",
        property_type=ConfigPropertyPropertyType.BOOLEAN,
    )
    resp = update_config_property.sync_detailed(client=client, body=prop)
    if resp.status_code == 200:
        print(f"✔ Enabled {source_name}")
        return True
    else:
        print(f"✗ Failed to enable {source_name}: status {resp.status_code}")
        return False


def set_sync_cadence(client, hours: int = 1) -> bool:
    """Set NVD mirror sync cadence (in hours)."""
    prop = ConfigProperty(
        group_name="task-scheduler",
        property_name="nist.mirror.cadence",
        property_value=str(hours),
        property_type=ConfigPropertyPropertyType.NUMBER,
    )
    resp = update_config_property.sync_detailed(client=client, body=prop)
    if resp.status_code == 200:
        print(f"✔ Set NVD sync cadence to {hours} hour(s)")
        return True
    else:
        print(f"✗ Failed to set sync cadence: status {resp.status_code}")
        return False


def main() -> int:
    """Enable vulnerability sources and configure sync cadence."""
    load_env()
    client = api.create_client_from_env()
    
    print("Enabling vulnerability sources...")
    
    # Enable multiple vulnerability sources
    sources_ok = True
    sources_ok &= enable_source(client, "nvd")
    sources_ok &= enable_source(client, "osv")
    sources_ok &= enable_source(client, "github.advisories")
    
    # Speed up sync for testing
    cadence_ok = set_sync_cadence(client, 1)
    
    if sources_ok and cadence_ok:
        print("\n✔ Vulnerability sources enabled successfully.")
        print("Initial sync may take 5-15 minutes. Monitor progress in the Dependency-Track UI.")
        return 0
    else:
        print("\n⚠ Some configuration steps failed. Check the output above.")
        return 1


if __name__ == "__main__":
    raise SystemExit(main())

